{"pageProps":{"allTags":{"biohacking":"biohacking","buffer-overflow":"buffer overflow","development":"Development","dll-injection":"DLL Injection","domains":"domains","ee":"EE","example":"example","how-to":"how to","makefile":"Makefile","memory":"memory","pcap":"pcap","phishing":"phishing","re":"RE","research":"research","rfid":"RFID","story":"Story","windows-api":"Windows API","windows-hacking":"Windows Hacking"},"title":"Phishing/Scam campaign research","slug":"phishing-campaign-research","date_published":1540617176000,"date_updated":1541023021000,"tags":["research","phishing"],"excerpt":"An email came in that an end user thought was suspicious. The end user passed it up to one of our team members, who then passed it up to me.","cover":"2018/10/image-3.jpg","author":{"name":"Pips","avatar":"avatars/pips.jpg"},"content":"<p>An email came in that an end user thought was suspicious. The end user passed it up to one of our team members, who then passed it up to me.</p>\n<figure><img src=\"/_next/static/images/image-320-69ea13b08b38cbb6ee56e3cd83aa1bac.jpg\" srcset=\"/_next/static/images/image-320-69ea13b08b38cbb6ee56e3cd83aa1bac.jpg 320w,/_next/static/images/image-473-0da8cb714f8e9950e94806e525aa5d20.jpg 473w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"473\" height=\"433\" alt=\"undefined\" loading=\"lazy\" /><figcaption>Initial phishing email</figcaption></figure>\n<p>To start off, this email is just dumb. The sender never bothered to copy legitimate Microsoft email formatting, and the wording is just strange. It doesn’t inspire even the most inexperienced users to “<strong><em>rectify password expiration</em></strong>”. Just for fun, let’s look at the url.</p>\n<figure><img src=\"/_next/static/images/image-2-320-83582c7bfeb02b784ded22d6b772e47e.jpg\" srcset=\"/_next/static/images/image-2-320-83582c7bfeb02b784ded22d6b772e47e.jpg 320w,/_next/static/images/image-2-590-5cc8ffc33b0e3cb9a185622e61721213.jpg 590w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"590\" height=\"215\" alt=\"undefined\" loading=\"lazy\" /><figcaption>Suspicious url</figcaption></figure>\n<p><code>hxxp://piba.org.br</code> isn’t a known phishing site, it goes to a Portuguese church website. The site doesn’t matter, what does matter is it looks like the script is being ran through a compromised WordPress site, since it’s going through a <code>/wp-content/</code> uploads folder. It appears that somebody could upload a script to the WordPress site that acts as a pass-through to further obfuscate and prevent the campaign from being detected.</p>\n<p>Once you click the link that passes through WordPress, you end up at a not-so-convincing office 365 login page.</p>\n<figure><img src=\"/_next/static/images/image-3-320-25e5dc9339b8bf250856c9787baf9896.jpg\" srcset=\"/_next/static/images/image-3-320-25e5dc9339b8bf250856c9787baf9896.jpg 320w,/_next/static/images/image-3-640-dae08558dadc4985179f5a9d1a0f0a15.jpg 640w,/_next/static/images/image-3-960-37cb085b4174fb74806a34369c17fc33.jpg 960w,/_next/static/images/image-3-1280-a9473d9c5bd8902a0645fc879ae38ae8.jpg 1280w,/_next/static/images/image-3-1289-93b613b2d9f204ec69a04a307d237191.jpg 1289w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"1289\" height=\"706\" alt=\"undefined\" loading=\"lazy\" /><figcaption>Bad credential harvesting page</figcaption></figure>\n<p>The email address in the link autofills the email box for your account. Let’s point out some interesting things about this scam site though. </p>\n<ul>\n<li>\n<p>the copyright on the bottom of the page has the <strong>wrong year</strong>.</p>\n</li>\n<li>\n<p>The site doesn't fill the entire page.</p>\n</li>\n<li>\n<p>The buttons and links don't work</p>\n<p>Why don’t they work? Because they’re <strong>images</strong>.</p>\n</li>\n</ul>\n<figure><img src=\"/_next/static/images/image-4-320-48d5a6c07356c547572f47902496502b.jpg\" srcset=\"/_next/static/images/image-4-320-48d5a6c07356c547572f47902496502b.jpg 320w,/_next/static/images/image-4-640-be0ad73bb9e26a87785252db355031bc.jpg 640w,/_next/static/images/image-4-771-5a6f217d3807d565637e477f8cf8821f.jpg 771w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"771\" height=\"589\" alt=\"undefined\" loading=\"lazy\" /><figcaption>Everything is a background image, instead of HTML/CSS</figcaption></figure>\n<p>Let’s look at the url and domain. <code>hxxp://fwclub.co.za/</code> is a winemaker’s club. It also doesn’t appear to be running any special framework either that would be exploitable.</p>\n<figure><img src=\"/_next/static/images/image-5-320-e8d2a7167b2c6c71e4f96990bb560ec9.jpg\" srcset=\"/_next/static/images/image-5-320-e8d2a7167b2c6c71e4f96990bb560ec9.jpg 320w,/_next/static/images/image-5-389-02f8bdd7258ec99d0e1d9ef6c1af288f.jpg 389w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"389\" height=\"536\" alt=\"undefined\" loading=\"lazy\" /><figcaption>No interesting services detected</figcaption></figure>\n<p>There are quite a few open ports as well on this server, four of them are CPanel. It’s possible that the person running this phishing campaign got access to the site’s CPanel and piggybacked off their normal traffic.</p>\n<p>Back to the original url, <code>hxxp://fwclub.co.za/includes/Office1/Login.php</code>. If we try one directory up, <code>/Office1/</code>, it redirects back to this script. So, lets go up another directory to <code>/includes/</code>.</p>\n<figure><img src=\"/_next/static/images/image-6-320-7563c3fc4a4063c927ac5dd062c88e31.jpg\" srcset=\"/_next/static/images/image-6-320-7563c3fc4a4063c927ac5dd062c88e31.jpg 320w,/_next/static/images/image-6-618-b40e540953b1370ca66e122d28c5e368.jpg 618w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"618\" height=\"510\" alt=\"undefined\" loading=\"lazy\" /><figcaption>All the scripts!</figcaption></figure>\n<p>Hmm, looks like directory listing is turned on, and… there’s a recent backup of their phishing campaign. Let’s look at this backup.</p>\n<img src=\"/_next/static/images/image-7-320-0f95bfaaa2af90315c4b239001372357.jpg\" srcset=\"/_next/static/images/image-7-320-0f95bfaaa2af90315c4b239001372357.jpg 320w,/_next/static/images/image-7-640-32c4d76dc392cdc02613511a63e1eacc.jpg 640w,/_next/static/images/image-7-960-42df4021a05d405535515bce39db5ae7.jpg 960w,/_next/static/images/image-7-1280-261a803ad2b561422a51c5941eda9c20.jpg 1280w,/_next/static/images/image-7-1419-ceb5e88bbade733df78f2d0e7873eefd.jpg 1419w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"1419\" height=\"365\" alt=\"undefined\" loading=\"lazy\" />\n<p>Yup, that’s the source code to the credential dumping code. A day later, the domain is shut down in one form or another :(</p>\n<img src=\"/_next/static/images/image-8-320-9a3fb3a92cc67525d33d96f465f223be.jpg\" srcset=\"/_next/static/images/image-8-320-9a3fb3a92cc67525d33d96f465f223be.jpg 320w,/_next/static/images/image-8-640-c7b86178f55648621aa8dd1171e5e6d5.jpg 640w,/_next/static/images/image-8-960-0a27be8c7a378a56c85f40627dd999b1.jpg 960w,/_next/static/images/image-8-1280-da2d13272dcd6ffcaa184679c9a3ef9e.jpg 1280w,/_next/static/images/image-8-1420-9ce6e693cb78123f028bcc7601946d59.jpg 1420w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"1420\" height=\"284\" alt=\"undefined\" loading=\"lazy\" />\n<p>Sophos also flagged the site, finally.</p>\n<img src=\"/_next/static/images/image-9-320-462ae4680d76b19097cb2786ce938dac.jpg\" srcset=\"/_next/static/images/image-9-320-462ae4680d76b19097cb2786ce938dac.jpg 320w,/_next/static/images/image-9-640-84e35d17079a8e6ea2d5aea5d903cf23.jpg 640w,/_next/static/images/image-9-835-e1536c5810f5a3967c3b20a7ce0f4247.jpg 835w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"835\" height=\"350\" alt=\"undefined\" loading=\"lazy\" />\n<p>Well, we’ve still got their source code, so let’s take a look. </p>\n<p><code>blocker.php</code> is a very interesting file.</p>\n<img src=\"/_next/static/images/image-10-320-67d48816ae948e9806abb7caa5f4d5ac.jpg\" srcset=\"/_next/static/images/image-10-320-67d48816ae948e9806abb7caa5f4d5ac.jpg 320w,/_next/static/images/image-10-640-eda17d4bbd9f36c86fc2da414804c76b.jpg 640w,/_next/static/images/image-10-960-a01f53c2df53f2f992abafa84a272086.jpg 960w,/_next/static/images/image-10-1280-1644ec913945a5c4086383db8cfa7d50.jpg 1280w,/_next/static/images/image-10-1409-a3bd6f854899154c7ef7d1f5a9b0d20a.jpg 1409w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"1409\" height=\"620\" alt=\"undefined\" loading=\"lazy\" />\n<p>The code uses a function I’ve never actually seen in PHP before, <code>gethostbyaddr()</code>, which attempts to lookup the incoming IP address to a hostname and possibly an identifier, like as Google or AWS, as well as the host names for a few other malware and phishing scanners.</p>\n<p>It also has a list of banned IP addresses, ranges from Google, Cogent, Digital Ocean, ISC, EQNET, INSC, Amazon, Softlayer, EIG, NTT America, MX Logic, British Telecom, Nianet, Elisa, GigeNET, University Of Minnesota(?), NetVision, NET1 Plus, Unified Webhosting, MULTACOM, China Unicom, Dassault Systèmes, Hurricane Electric, CoreSpace, SITA, Orange S.A, Cyber Wurx, CYBERCON, Zayo Bandwidth, Savvis, QTS, Kasetsart University in Thailand(?), Chungnam National University in South Korea(?), RCC, USAA, Comverse, Omnico Hosting, AT&#x26;T, Marlink, Airstream, The Department of Defense Network Information Center, and DataPipe. Whew, that was a long list. </p>\n<p>The major group of IP ranges are hosting providers that have a large amount of traffic for VPN/Proxy services. It would make sense that the Phisher’s target audience falls outside of hosting companies, it falls to individual users and companies. The second interesting group of IPs are for a few Universities, none in the list make any sense though. Only one of them has a recognized Cybersecurity course. It appears that MXLogic is also on the list, probably to avoid enterprise email filtering detection for companies that use it. I also found it a little interesting that they blocked the DoD as well.</p>\n<p>The last bit of code simply checks if the useragent falls under msnbot, google bot, yahoo bot, etc. They also have a robots.txt that does the same thing.</p>\n<p>Once it has checked the incoming request, the index.php file sets the header (URL) to something along the lines of  <code>login.php?websrc=&#x3C;random numbers>&#x26;dispatched=&#x3C;random numbers>&#x26;id=&#x3C;random numbers>&#x26;email=&#x3C;compromised email></code>. It’s interesting that the phishing author attempted to make the URL look more legitimate and lengthy, as many official emails are.</p>\n<img src=\"/_next/static/images/image-11-320-b9851445719ff2ab6ce930e2bd7b7e20.jpg\" srcset=\"/_next/static/images/image-11-320-b9851445719ff2ab6ce930e2bd7b7e20.jpg 320w,/_next/static/images/image-11-640-e0b4020a44961c30b01fffca6be2c212.jpg 640w,/_next/static/images/image-11-960-65c1af578d53d622585df957a7f637f2.jpg 960w,/_next/static/images/image-11-1280-2c05dc018f3493c6f7e74f330d78b801.jpg 1280w,/_next/static/images/image-11-1412-e5ba912c4e28d397241535bb3e8dc0a7.jpg 1412w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"1412\" height=\"264\" alt=\"undefined\" loading=\"lazy\" />\n<p>Once it goes to the Login.php page, it loads the two images and two text boxes that are supposed to look like, and auto fills the email address, to make it look more “authentic”.</p>\n<p>On the form submit, it hits <code>logon.php</code> (not login). Here’s where something interesting happens. The first thing the script does, is gets the visitors country from geoplugin.net. The second thing it does, is craft a basic email and loads in the submitted username, password, ip, browser, date, and geoip lookup. It then sets the TO: field of this email to <a href=\"mailto:ipconfigura@gmail.com\">ipconfigura@gmail.com</a>, the subject to <code>“Office365 | &#x3C;country> | &#x3C;username>”</code>  and lastly sets the FROM: field to <code>“John De Fisher &#x3C;new@cpanel.com>”</code>.</p>\n<img src=\"/_next/static/images/image-12-320-fe2e084c33a3684c0c040b8b60bfafc9.jpg\" srcset=\"/_next/static/images/image-12-320-fe2e084c33a3684c0c040b8b60bfafc9.jpg 320w,/_next/static/images/image-12-640-f514ed1741ed1e155e732ea14c7f0d73.jpg 640w,/_next/static/images/image-12-960-75b7279498602835175664549f7dac11.jpg 960w,/_next/static/images/image-12-1011-6272c382c12916d9769de8b47d6e1c5e.jpg 1011w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"1011\" height=\"668\" alt=\"undefined\" loading=\"lazy\" />\n<p>After it crafts this email, it then runs a function called <code>check()</code> from inside a PHPMailer directory from the script <code>smtp.php</code>, and passes the submitted username and password. Let’s look at this script then.</p>\n<img src=\"/_next/static/images/image-13-320-ba40c1724d40bb3b9a7627a69ff474ff.jpg\" srcset=\"/_next/static/images/image-13-320-ba40c1724d40bb3b9a7627a69ff474ff.jpg 320w,/_next/static/images/image-13-640-201e1f5a59c86dc94702f1b069e1ccb5.jpg 640w,/_next/static/images/image-13-710-18be36b3f67324d7bdec0a9432217a49.jpg 710w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"710\" height=\"312\" alt=\"undefined\" loading=\"lazy\" />\n<p>This <code>check()</code> function is incredibly clever. It connects to the office365 SMTP server, authenticates with the server using the submitted credentials, sets the FROM field to the email <code>hbergamini@truehomesusa.com</code>. This is interesting, <code>truehomesusa.com</code> doesn’t seem to be flagged and is a legitimate website, they even run on office 365. I take an educated guess and figure that this domain has not fully set up the correct MX records to protect their domain from email spoofing, allowing this test email to not be noticed by most people and not appear in anybody’s inbox. Clever. It then checks to see if the email sent. If it could send, it means that the submitted credentials successfully authenticated with Microsoft and are correct. </p>\n<p>This is something I don’t see that often. It’s commonplace for campaigns to accept and send off any credentials it gets, but this one is checking the validity of the credentials. It also allows the phishing author to provide a “Password not recognized” message, to skeptical users who input a wrong password the first time to see if it works or not.</p>\n<img src=\"/_next/static/images/image-14-320-e2073fb98809ab2edc08dba4cc3cb860.jpg\" srcset=\"/_next/static/images/image-14-320-e2073fb98809ab2edc08dba4cc3cb860.jpg 320w,/_next/static/images/image-14-640-4766253bbb6ee5998deedc52ade2e981.jpg 640w,/_next/static/images/image-14-960-5a4ea92b0d857b7f209e6f6a915ec859.jpg 960w,/_next/static/images/image-14-1175-a5cf40e520f795b9329f34844d66423e.jpg 1175w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"1175\" height=\"756\" alt=\"undefined\" loading=\"lazy\" />\n<p>Aaand that's the analysis of this phishing campaign.</p>\n"},"__N_SSG":true}