{"pageProps":{"allTags":{"biohacking":"biohacking","buffer-overflow":"buffer overflow","development":"Development","dll-injection":"DLL Injection","domains":"domains","ee":"EE","how-to":"how to","makefile":"Makefile","memory":"memory","pcap":"pcap","phishing":"phishing","re":"RE","research":"research","rfid":"RFID","story":"Story","windows-api":"Windows API","windows-hacking":"Windows Hacking"},"title":"An easier SaltLAN","slug":"an-easier-saltlan","date_published":1543375206000,"date_updated":1543375255000,"tags":[],"excerpt":"My family does an annual LAN Party and one of the biggest complaints we have is that Steam takes ages to download for everyone.","cover":"2018/11/image-12.jpg","author":{"name":"bashNinja","avatar":"avatars/bashNinja.jpeg"},"content":"<p>My family does an annual LAN Party and one of the biggest complaints we have is that Steam takes ages to download for everyone. </p>\n<p>This year things are going to be different. I want to follow in the footsteps of SaltLAN and setup some caching. As this progressed, I spiced things up with my own flare and thought I would share.</p>\n<p>The primary guide I followed was:\n<a href=\"https://github.com/SaltLAN/Configuration/blob/master/SETUP.md\">https://github.com/SaltLAN/Configuration/blob/master/SETUP.md</a>\ndone by <a href=\"https://twitter.com/pips801\">@Pips801</a>. </p>\n<h3>Step 1 - Get a Server</h3>\n<p>I have a server I use for various projects and environments.\nSuperMicro E300-8D\nYou can read about a similar setup on a fellow 801Labs member's blog at:\n<a href=\"https://securedumby.science/view-post/dumbyland_beginning_\">https://securedumby.science/view-post/dumbyland<em>beginning</em></a></p>\n<h3>Step 2 - Install a VM</h3>\n<p>I am installing a Ubuntu 18.04 VM onto this server. The primary trick with the VM is that I setup 2 hard drives so that I can utilize the BLAZING FAST NVMe drive I have in this server for the caching. After this LAN party, I'm going to delete/shrink the cache drive since it won't be needed later and I want to keep the NVMe space available for other projects. I'll keep the OS &#x26; Dockers on the mSata drive, powered off, for future use.</p>\n<figure><img src=\"/_next/static/images/image-4-320-1d19bb437fac6399471fc6ac87d9d6ff.jpg\" srcset=\"/_next/static/images/image-4-320-1d19bb437fac6399471fc6ac87d9d6ff.jpg 320w,/_next/static/images/image-4-588-c6d6fc48f695b6a3c60c38daeb25b31d.jpg 588w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"588\" height=\"288\" alt=\"undefined\" loading=\"lazy\" /><figcaption>VM Configuration</figcaption></figure>\n<p>Follow the normal Ubuntu install setup.</p>\n<p>Update Ubuntu:</p>\n<pre><code>sudo apt update\nsudo apt dist-upgrade -y\nsudo reboot\n</code></pre>\n<p>Enable SSH:</p>\n<pre><code>sudo systemctl enable ssh\nsudo systemcts start ssh\n</code></pre>\n<h3>Step 3 - Setup Docker</h3>\n<p>This should be pretty easy. Follow the official instructions:\n<a href=\"https://docs.docker.com/install/linux/docker-ce/ubuntu/\">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p>\n<h3>Step 4 - Install Portainer.io</h3>\n<p>Follow the official instructions:\n<a href=\"https://portainer.io/install.html\">https://portainer.io/install.html</a></p>\n<p>I deviated from the official Portainer guide by not creating a portainer data container, and rather mounting to the filesystem. I did this so I can backup the settings easily.</p>\n<pre><code>sudo mkdir /opt/appdata/\ndocker run -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock -v /opt/appdata/portainer:/data --restart unless-stopped --name portainer portainer/portainer\n</code></pre>\n<img src=\"/_next/static/images/image-5-320-721deedd516aff7bed9f78aa10798d92.jpg\" srcset=\"/_next/static/images/image-5-320-721deedd516aff7bed9f78aa10798d92.jpg 320w,/_next/static/images/image-5-640-e123c205fff9296936612e38fd0bc630.jpg 640w,/_next/static/images/image-5-667-f7da29490a766a0aeede1a1e52d89a57.jpg 667w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"667\" height=\"323\" alt=\"undefined\" loading=\"lazy\" />\n<p>Bam! Now you should be able to access Portainer</p>\n<h3>Step 5 - Format &#x26; Automount Cache Drive</h3>\n<p>I followed this guide to format my 700GBs of NVMe storage for cache\n<a href=\"https://www.digitalocean.com/community/tutorials/how-to-partition-and-format-storage-devices-in-linux\">https://www.digitalocean.com/community/tutorials/how-to-partition-and-format-storage-devices-in-linux</a></p>\n<pre><code>sudo parted /dev/sdb mklabel gpt\nsudo parted -a opt /dev/sdb mkpart primary ext4 0% 100%\nsudo mkfs.ext4 -L cache /dev/sdb1\n</code></pre>\n<p>Don't forget to add the drive to <code>/etc/fstab</code> so that it will auto-mount. I have mine mounting to <code>/cache</code> in the root of the system.</p>\n<h3>Step 5 - Setup Network for Containers</h3>\n<p>We want to give each container a unique IP address on the network, so we need to create a unique IP address for each container so that can happen.</p>\n<p>Since Ubuntu 18.04 uses netplan instead of <code>/etc/network/interfaces</code> , let's try that out. </p>\n<p>Create a <code>lanparty.yaml</code> file with your IPs.</p>\n<pre><code>network:\n    ethernets:\n        ens160:\n            addresses:\n                [10.0.0.2/24, 10.42.0.3/24, 10.42.0.4/24, 10.42.0.5/24]\n            gateway4: 10.0.0.1\n            nameservers:\n                    addresses:\n                            - 10.0.0.1\n    version: 2\n</code></pre>\n<p>Then you'll need to restart netplan for the new IPs: <code>sudo netplan apply</code></p>\n<h3>Step 6 - Install the Various Containers</h3>\n<p>We're going to create a container for each service we want to cache. SaltLAN shows this is what it would look like if we were to create the commands manually:\nServiceCommandSteam<code>sudo docker run --name steam-cache -p 10.0.0.2:80:80 -d steamcache/steamcache</code>Battle.net<code>sudo docker run --name blizzard-cache -p 10.0.0.3:80:80 -d steamcache/generic</code>Origin<code>sudo docker run --name origin-cache -p 10.0.0.4:80:80 -d steamcache/generic</code>Uplay<code>sudo docker run --name uplay-cache -p 10.0.0.5:80:80 -d steamcache/generic</code>Riot<code>sudo docker run --name riot-cache -p 10.0.0.6:80:80 -d steamcache/generic</code>Frontier<code>sudo docker run --name frontier-cache -p 10.0.0.7:80:80 -d steamcache/generic</code>Windows<code>sudo docker run --name windows-cache -p 10.0.0.8:80:80 -d steamcache/generic</code>Twitch<code>sudo docker run --name twitch-cache -p 10.0.0.9:80:80 -d steamcache/twitch</code>\nAgain, since we're going to put our own twist on it, these will be different. Specifically we're going to add a mountpath inside the container to point to our NVMe drive AND we're going to do it all using Portainer's GUI.</p>\n<p>Containers -> + Add Container</p>\n<p>Then fill in the Settings. I'll show screenshots for a Steam Cache:</p>\n<figure><img src=\"/_next/static/images/Screenshot_2018-11-19-18.52.56_wehvoV-320-2a2fa883c7b08fbf6091d34ba8476d59.jpg\" srcset=\"/_next/static/images/Screenshot_2018-11-19-18.52.56_wehvoV-320-2a2fa883c7b08fbf6091d34ba8476d59.jpg 320w,/_next/static/images/Screenshot_2018-11-19-18.52.56_wehvoV-640-663f7b63d3dbe24b99d8e86408475e3f.jpg 640w,/_next/static/images/Screenshot_2018-11-19-18.52.56_wehvoV-960-a16dbe4d118c5f6016ec105a022048d9.jpg 960w,/_next/static/images/Screenshot_2018-11-19-18.52.56_wehvoV-1148-3d59d515f199537bcc6e2021ff0cd2c0.jpg 1148w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"1148\" height=\"692\" alt=\"undefined\" loading=\"lazy\" /><figcaption>Main Steam Container Settings</figcaption></figure>\n<figure><img src=\"/_next/static/images/image-8-320-6e5a6b06640c4d0611fb923ce1c1a502.jpg\" srcset=\"/_next/static/images/image-8-320-6e5a6b06640c4d0611fb923ce1c1a502.jpg 320w,/_next/static/images/image-8-640-369901fa5175b2033ab571ba1d56031c.jpg 640w,/_next/static/images/image-8-817-342f38694e63d1adcbbabfb2a36e6edd.jpg 817w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"817\" height=\"375\" alt=\"undefined\" loading=\"lazy\" /><figcaption>Steam Volume Mount Paths</figcaption></figure>\n<figure><img src=\"/_next/static/images/image-10-320-c1b5c848f8cc88ca97b4c292b3f8a87b.jpg\" srcset=\"/_next/static/images/image-10-320-c1b5c848f8cc88ca97b4c292b3f8a87b.jpg 320w,/_next/static/images/image-10-640-8cfd71a25788ebefb8e80b34f6bd1bd3.jpg 640w,/_next/static/images/image-10-849-4bcc39be3cf7685fec2f09ce783867c2.jpg 849w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"849\" height=\"276\" alt=\"undefined\" loading=\"lazy\" /><figcaption>Steam Restart Policy</figcaption></figure>\n<p>Once all those are done, you can go ahead and deploy the container.</p>\n<p>Create containers for each of the different services.</p>\n<p>You'll want to read the <a href=\"https://github.com/steamcache/generic\">steamcache/generic</a> guide. If you're using SNIProxy or SteamDNS (you should use both), you'll set the port mapping just to something like <code>443:443</code>, without any IPs. That'll make it so that it is mapped to <em>all</em> IPs.</p>\n<p>Also, There are environmental variables you need to set to configure things for your environment.</p>\n<p>The only one I'll show is the SteamDNS env variables:</p>\n<figure><img src=\"/_next/static/images/image-13-320-45b38354730f67ed0870acb343deacab.jpg\" srcset=\"/_next/static/images/image-13-320-45b38354730f67ed0870acb343deacab.jpg 320w,/_next/static/images/image-13-640-53da297487c793ecfbbaf5e6ecc6f07f.jpg 640w,/_next/static/images/image-13-960-98f4679a86e275c52a7dabcfba65fb54.jpg 960w,/_next/static/images/image-13-1153-bfda6fa08d8971500c554333c0dd91c9.jpg 1153w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"1153\" height=\"439\" alt=\"undefined\" loading=\"lazy\" /><figcaption>SteamDNS ENV Variables</figcaption></figure>\n<p>Beyond that, you can handle it. Here's what mine looked like completed:</p>\n<figure><img src=\"/_next/static/images/image-12-320-15378e1e5368da349664bdc4b6119ee1.jpg\" srcset=\"/_next/static/images/image-12-320-15378e1e5368da349664bdc4b6119ee1.jpg 320w,/_next/static/images/image-12-640-a91c7d2f042f4fa5c9b6f5e8522e38da.jpg 640w,/_next/static/images/image-12-960-06df901c1baed8d098bedf595f70e1c8.jpg 960w,/_next/static/images/image-12-1141-3b4f805b4378070f8f9e83f2c1d93ce5.jpg 1141w\" sizes=\"(min-width: 960px) 960px, 100vw\" width=\"1141\" height=\"472\" alt=\"undefined\" loading=\"lazy\" /><figcaption>All Caching Containers</figcaption></figure>\n<h3>Step 7 - Set your router DNS</h3>\n<p>This step is the last step before things start taking effect. You need to go to your router and change your DNS server to a local one. This was <em>not</em> as common a feature as I hoped it would be. This may require you to get a nice router and setup OpenWRT or something similar onto it to get that running. Good luck on this one.</p>\n<h3>Step 8 - Analytics &#x26; Maintenance</h3>\n<p>There are a lot of tools that you can setup for this. I didn't really care about it.\nAll I did was tweak the script <a href=\"https://github.com/SaltLAN/Configuration/blob/master/scripts/saltlan\">from SaltLAN</a> and make it fit my environment. You can find that <a href=\"https://gist.github.com/miketweaver/9f8e60db3ee5cbe7dd0cde6b88184956\">here</a>. </p>\n<h2>Enjoy!</h2>\n<p>I hope you have enjoyed this guide. I had a lot of fun at my LAN Party and a lot of games were had!</p>\n<p>The cache worked very well for use. We saved over 1TB of data transferred, which would have killed our Comcast Data Cap. We did run into issues where we were limited by the 1GBs cap and the Samba Share would only <em>really</em> push to one person at a time, so I'll look at ways of improving this.</p>\n<p>In the future I hope to look at stuff such as <a href=\"https://pthree.org/2012/12/07/zfs-administration-part-iv-the-adjustable-replacement-cache/\">Linux ZFS ARC</a> and setting up 10G networking.</p>\n<p>with ❤️️\n-- <a href=\"https://twitter.com/_bashNinja\">bashNinja</a></p>\n"},"__N_SSG":true}